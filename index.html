<!DOCTYPE html>
<html>
<head>
    <title>Room Area Manager | Draw & Save</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
        }

        .container {
            display: flex;
            max-width: 1400px;
            margin: 20px auto;
            gap: 20px;
        }

        .control-panel, .saved-rooms-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .control-panel {
            flex: 1; 
            max-width: 400px;
        }

        .map-container {
            flex: 3; 
        }

        #map {
            height: 600px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        h3 {
            color: #007bff;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
        }

        input[type="text"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-right: 8px;
        }

        #saveUpdateButton {
            background-color: #28a745; 
            color: white;
            width: 100%;
            margin-bottom: 15px;
        }

        #saveUpdateButton:hover {
            background-color: #218838;
        }

        .saved-rooms-card {
            margin-top: 20px;
        }

        .room-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }

        .room-item:last-child {
            border-bottom: none;
        }

        .room-item span {
            font-weight: 500;
        }

        .action-buttons button {
            padding: 5px 10px;
            font-size: 0.85em;
        }

        .edit-btn {
            background-color: #ffc107;
            color: #333;
        }

        .edit-btn:hover {
            background-color: #e0a800;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="control-panel">
            <h3>Draw Room Area on Map üó∫Ô∏è</h3>
            <input type="text" id="roomName" placeholder="Enter room name">
            <input type="hidden" id="roomId" value=""> <button id="saveUpdateButton" onclick="saveOrUpdatePolygon()">Save New Room</button>
            <p style="font-size: 0.9em; color: #666;">
                1. Select the Polygon tool on the map. <br>
                2. Draw your room area. <br>
                3. Enter a name and click 'Save'.
            </p>

            <div class="saved-rooms-card">
                <h3>Saved Rooms Management üõ†Ô∏è</h3>
                <div id="roomsList">
                    <p style="text-align: center; color: #999;">Loading rooms...</p>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBaHd0WsHpsTZRtBbevPBqOmAeVsUSvCjw",
            authDomain: "attendease-26a15.firebaseapp.com",
            databaseURL: "https://attendease-26a15-default-rtdb.firebaseio.com",
            projectId: "attendease-26a15",
            storageBucket: "attendease-26a15.appspot.com",
            messagingSenderId: "246473705713",
            appId: "1:246473705713:android:0abb65affc494845ba4150"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const roomsRef = ref(db, "rooms");

        window.currentRoomKey = null; 

        window.saveOrUpdatePolygon = function () {
            const roomName = document.getElementById("roomName").value.trim();
            const currentId = document.getElementById("roomId").value;

            if (!roomName) {
                alert("Please enter a room name!");
                return;
            }

            if (!window.coordinates || window.coordinates.length === 0) {
                 if (!currentId) {
                     alert("Draw a polygon first!");
                     return;
                 }
            }
            
            const data = {
                name: roomName,
                ...(window.coordinates && window.coordinates.length > 0 && { polygon: window.coordinates }) 
            };


            if (currentId) {
                // UPDATE operation
                const roomReference = ref(db, `rooms/${currentId}`);
                update(roomReference, data)
                    .then(() => {
                        alert(`Room "${roomName}" updated successfully!`);
                        resetForm();
                    })
                    .catch(console.error);
            } else {
                // CREATE operation
                const roomRef = push(roomsRef);
                set(roomRef, {
                    name: roomName,
                    polygon: window.coordinates
                })
                    .then(() => {
                        alert(`Room "${roomName}" saved to Firebase!`);
                        resetForm();
                    })
                    .catch(console.error);
            }
        };

        //DELETE 
        window.deletePolygon = function (key, name) {
            if (confirm(`Are you sure you want to delete the room: ${name}?`)) {
                const roomReference = ref(db, `rooms/${key}`);
                remove(roomReference)
                    .then(() => {
                        alert(`Room "${name}" deleted successfully.`);
                    })
                    .catch(console.error);
            }
        };
        
        window.editRoom = function(key, name) {
             document.getElementById("roomName").value = name;
             document.getElementById("roomId").value = key;
             document.getElementById("saveUpdateButton").textContent = `Update Room: ${name}`;
             document.getElementById("saveUpdateButton").style.backgroundColor = '#007bff';

             if (window.selectedShape) {
                 window.selectedShape.setMap(null);
                 window.selectedShape = null;
                 window.coordinates = [];
             }
             
             alert(`Editing room: ${name}. Re-draw the polygon to update coordinates, or just click 'Update' to save the name change.`);
        };
        
        function resetForm() {
             document.getElementById("roomName").value = "";
             document.getElementById("roomId").value = "";
             document.getElementById("saveUpdateButton").textContent = "Save New Room";
             document.getElementById("saveUpdateButton").style.backgroundColor = '#28a745';
             if (window.selectedShape) {
                 window.selectedShape.setMap(null);
                 window.selectedShape = null;
             }
             window.coordinates = [];
        }

        window.loadPolygonsFromFirebase = function () {
            onValue(roomsRef, (snapshot) => {
                const roomsListElement = document.getElementById("roomsList");
                roomsListElement.innerHTML = "";

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    let listHTML = '';
                    if (window.savedPolygons) {
                        window.savedPolygons.forEach(p => p.setMap(null));
                    }
                    window.savedPolygons = [];
                    
                    Object.keys(data).forEach(key => {
                        const room = data[key];
                        const polygonPaths = room.polygon || [];

                        if (polygonPaths.length > 0) {
                            const polygon = new google.maps.Polygon({
                                paths: polygonPaths,
                                map: window.map,
                                strokeColor: "#00bcd4",
                                strokeOpacity: 0.8,
                                strokeWeight: 3,
                                fillColor: "#00bcd4",
                                fillOpacity: 0.3
                            });

                            const info = new google.maps.InfoWindow({
                                content: `<b>${room.name}</b><br>ID: ${key}`
                            });
                            polygon.addListener("click", (e) => {
                                info.setPosition(e.latLng);
                                info.open(window.map);
                            });

                            window.savedPolygons.push(polygon);
                        }

                        listHTML += `
                            <div class="room-item">
                                <span>${room.name}</span>
                                <div class="action-buttons">
                                    <button class="edit-btn" onclick="editRoom('${key}', '${room.name}')">Edit</button>
                                    <button class="delete-btn" onclick="deletePolygon('${key}', '${room.name}')">Delete</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    roomsListElement.innerHTML = listHTML;

                } else {
                    roomsListElement.innerHTML = '<p style="text-align: center; color: #999;">No saved rooms found.</p>';
                }
            });
        };
        
        window.resetForm = resetForm;
    </script>

    <script>
        let drawingManager, selectedShape;
        window.coordinates = [];
        
        function initMap() {
            const location = { lat: 7.45743501153113, lng: 125.79222460310352 }; 
            window.map = new google.maps.Map(document.getElementById("map"), {
                center: location,
                zoom: 18,
                mapTypeId: google.maps.MapTypeId.HYBRID,
                disableDefaultUI: true, 
                zoomControl: true,
                mapTypeControl: true,
            });

            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.POLYGON,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: ["polygon"]
                },
                polygonOptions: { 
                    editable: true,
                    strokeColor: "#28a745", 
                    strokeOpacity: 0.8,
                    strokeWeight: 3,
                    fillColor: "#28a745",
                    fillOpacity: 0.35 
                }
            });

            drawingManager.setMap(window.map);
            
            google.maps.event.addListener(drawingManager, "overlaycomplete", function (event) {
                if (event.type === google.maps.drawing.OverlayType.POLYGON) {
                    if (selectedShape) selectedShape.setMap(null);
                    
                    selectedShape = event.overlay;
                    window.coordinates = [];
                    selectedShape.getPath().forEach(latLng => {
                        window.coordinates.push({ lat: latLng.lat(), lng: latLng.lng() });
                    });
                    
                    google.maps.event.addListener(selectedShape.getPath(), 'set_at', updateCoordinates);
                    google.maps.event.addListener(selectedShape.getPath(), 'insert_at', updateCoordinates);
                    
                    console.log("New Polygon Coordinates Ready:", window.coordinates);
                }
            });
            
            function updateCoordinates() {
                 window.coordinates = [];
                 selectedShape.getPath().forEach(latLng => {
                     window.coordinates.push({ lat: latLng.lat(), lng: latLng.lng() });
                 });
                 console.log("Coordinates Updated by Edit:", window.coordinates);
            }

            if (window.loadPolygonsFromFirebase) {
                window.loadPolygonsFromFirebase();
            }
            
            drawingManager.setDrawingMode(null);
        }

        window.initMap = initMap; 
    </script>
    
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBpPWqC8WkQBP3cWKeXfaZYYnfpkrszlvE&libraries=drawing&callback=initMap">
    </script>
</body>
</html>